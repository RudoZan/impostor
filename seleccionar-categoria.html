<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Categor√≠a - El Impostor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main>
        <section class="hero">
            <div class="welcome-container">
                <h2>IMPOSTOR</h2>
                
                <div class="sesion-info-display">
                    <div class="session-info-large">
                        <div class="session-info-line">
                            <span class="user-item" id="user-name-header" style="display: none;">Usuario: <strong id="nombre-usuario-header">---</strong></span>
                            <span class="session-item">Sesi√≥n: <strong id="numero-sesion-header">---</strong></span>
                        </div>
                    </div>
                </div>
                
                <div class="selector-categoria">
                    <h3>Elige una categor√≠a para un nuevo juego</h3>
                    <div id="lista-categorias" class="lista-categorias"></div>
                </div>
                
                <div class="sesion-actions-bottom">
                    <a href="sesion.html" class="btn-back">‚Üê Volver a la sesi√≥n</a>
                </div>
            </div>
        </section>
    </main>

    <script src="script.js"></script>
    <!-- Supabase SDK for database integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <script>
        // Inicializar p√°gina de selecci√≥n de categor√≠a
        async function initSeleccionarCategoria() {
            const sessionNumber = localStorage.getItem('sessionNumber');
            
            // Si no hay datos de sesi√≥n, redirigir al inicio
            if (!sessionNumber) {
                alert('No se encontr√≥ informaci√≥n de sesi√≥n. Redirigiendo al inicio...');
                window.location.href = 'index.html';
                return;
            }
            
            // Verificar que el usuario es admin
            const sessionType = localStorage.getItem('sessionType');
            if (sessionType !== 'admin') {
                alert('Solo el admin puede iniciar el juego. Redirigiendo...');
                window.location.href = 'sesion.html';
                return;
            }
            
            // Actualizar n√∫mero de sesi√≥n
            const numeroSesionHeader = document.getElementById('numero-sesion-header');
            if (numeroSesionHeader) {
                numeroSesionHeader.textContent = sessionNumber;
            }
            
            // Actualizar nombre de usuario
            const userName = localStorage.getItem('userName');
            if (userName) {
                const userNameHeader = document.getElementById('user-name-header');
                const nombreUsuarioHeader = document.getElementById('nombre-usuario-header');
                if (userNameHeader && nombreUsuarioHeader) {
                    nombreUsuarioHeader.textContent = userName;
                    userNameHeader.style.display = 'block';
                }
            }
            
            // Cargar categor√≠as
            cargarCategorias();
            
            // Mostrar lista de categor√≠as
            mostrarSelectorCategorias();
        }
        
        // Mostrar selector de categor√≠as
        function mostrarSelectorCategorias() {
            if (!categoriasData) {
                alert('Error: No se pudieron cargar las categor√≠as');
                return;
            }
            
            const listaCategorias = document.getElementById('lista-categorias');
            if (!listaCategorias) return;
            
            listaCategorias.innerHTML = '';
            
            Object.keys(categoriasData).forEach(categoria => {
                const botonCategoria = document.createElement('button');
                botonCategoria.className = 'btn-categoria';
                botonCategoria.textContent = categoria;
                botonCategoria.addEventListener('click', function() {
                    iniciarJuegoConCategoria(categoria);
                });
                listaCategorias.appendChild(botonCategoria);
            });
        }
        
        // Iniciar juego con una categor√≠a seleccionada
        async function iniciarJuegoConCategoria(categoria) {
            const sessionNumber = localStorage.getItem('sessionNumber');
            const userName = localStorage.getItem('userName');
            
            if (!sessionNumber || !userName) {
                alert('Error: No se encontr√≥ informaci√≥n de sesi√≥n o usuario');
                return;
            }
            
            // Obtener lista de usuarios de la sesi√≥n
            const usuarios = await obtenerUsuariosSesion(sessionNumber);
            
            // Filtrar usuarios v√°lidos
            const usuariosValidos = usuarios.filter(usuario => 
                usuario && usuario.usuario && usuario.usuario.trim() !== ''
            );
            
            if (usuariosValidos.length < 3) {
                alert('Se necesitan al menos 3 usuarios para jugar');
                return;
            }
            
            // Elegir elemento aleatorio de la categor√≠a
            const elementos = categoriasData[categoria];
            const elementoElegido = elementos[Math.floor(Math.random() * elementos.length)];
            
            // Elegir impostor aleatorio
            const impostorIndex = Math.floor(Math.random() * usuariosValidos.length);
            const impostor = usuariosValidos[impostorIndex];
            
            // Crear estado del juego
            const estadoJuego = {
                categoria: categoria,
                elemento: elementoElegido,
                impostor: impostor.usuario,
                activo: true,
                iniciadoPor: userName,
                iniciadoEn: new Date().toISOString()
            };
            
            // Guardar estado del juego en Supabase
            console.log('üíæ Guardando juego en Supabase...');
            console.log('üìã Estado del juego a guardar:', estadoJuego);
            
            await guardarEstadoJuego(sessionNumber, estadoJuego);
            console.log('‚úÖ Juego guardado, esperando confirmaci√≥n...');
            
            // Esperar un momento para asegurar que Supabase procese el cambio
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Verificar que se guard√≥ correctamente antes de redirigir
            console.log('üîç Verificando que el juego se guard√≥ correctamente...');
            
            // Redirigir de vuelta a la sesi√≥n
            console.log('‚û°Ô∏è Redirigiendo a sesion.html...');
            window.location.href = 'sesion.html';
        }
        
        // Inicializar cuando se carga la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSeleccionarCategoria);
        } else {
            initSeleccionarCategoria();
        }
    </script>
    
    <footer>
        <p>Impostor v1.0 desarrollado por Astutosoft ¬© 2025</p>
    </footer>
</body>
</html>

