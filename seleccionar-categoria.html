<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Selecciona una categor√≠a para iniciar un nuevo juego de Impostor.">
    <meta name="keywords" content="impostor, juego, categor√≠a, seleccionar">
    <meta name="author" content="Astutosoft">
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Impostor">
    <title>Impostor - Seleccionar Categor√≠a</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <main>
        <section class="hero">
            <div class="welcome-container">
                <h2 class="titulo-con-imagen">
                    <img src="impostor.png" alt="Logo de Impostor" class="logo-impostor" loading="lazy">
                    IMPOSTOR
                </h2>
                
                <div class="sesion-info-display">
                    <div class="session-info-large">
                        <div class="session-info-line">
                            <span class="user-item" id="user-name-header" style="display: none;">Usuario: <strong id="nombre-usuario-header">---</strong></span>
                            <span class="session-item">Sesi√≥n: <strong id="numero-sesion-header">---</strong></span>
                        </div>
                    </div>
                </div>
                
                <div class="selector-categoria">
                    <h3>Elige una categor√≠a para un nuevo juego</h3>
                    <div id="lista-categorias" class="lista-categorias"></div>
                    <p class="mensaje-categoria-hint">üí° Mant√©n presionada una categor√≠a para ver su contenido</p>
                </div>
                
                <div class="sesion-actions-bottom">
                    <a href="sesion.html" class="btn-back">‚Üê Volver a la sesi√≥n</a>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Modal de carga -->
    <div id="modal-cargando" class="modal-overlay modal-cargando" style="display: none;">
        <div class="modal-content modal-cargando-content">
            <div class="spinner"></div>
            <h3 id="modal-cargando-title">Cargando nuevo juego...</h3>
            <p>Por favor espera mientras se genera el juego</p>
        </div>
    </div>

    <!-- Modal de elementos de categor√≠a -->
    <div id="modal-elementos-categoria" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-elementos-content">
            <h3 id="titulo-categoria-modal"></h3>
            <div id="lista-elementos-categoria" class="lista-elementos-categoria"></div>
            <button class="btn-confirmar" id="btn-cerrar-elementos">Cerrar</button>
        </div>
    </div>

    <!-- Prefetch para mejorar performance de navegaci√≥n -->
    <link rel="prefetch" href="index.html">
    <link rel="prefetch" href="sesion.html">
    
    <script src="script.js"></script>
    <!-- Supabase SDK for database integration -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <script>
        // Inicializar p√°gina de selecci√≥n de categor√≠a
        async function initSeleccionarCategoria() {
            // Usar SessionCache para mejor performance (optimizaci√≥n)
            const sessionNumber = SessionCache.getSessionNumber();
            
            // Si no hay datos de sesi√≥n, redirigir al inicio
            if (!sessionNumber) {
                // Usar notificaci√≥n si est√° disponible, sino alert
                if (typeof NotificationUtils !== 'undefined') {
                    NotificationUtils.error('No se encontr√≥ informaci√≥n de sesi√≥n. Redirigiendo al inicio...');
                } else {
                    alert('No se encontr√≥ informaci√≥n de sesi√≥n. Redirigiendo al inicio...');
                }
                window.location.href = 'index.html';
                return;
            }
            
            // Verificar que el usuario es admin (usando SessionCache)
            const sessionType = SessionCache.getSessionType();
            if (sessionType !== 'admin') {
                if (typeof NotificationUtils !== 'undefined') {
                    NotificationUtils.warning('Solo el admin puede iniciar el juego. Redirigiendo...');
                } else {
                    alert('Solo el admin puede iniciar el juego. Redirigiendo...');
                }
                window.location.href = 'sesion.html';
                return;
            }
            
            // Actualizar n√∫mero de sesi√≥n
            const numeroSesionHeader = document.getElementById('numero-sesion-header');
            if (numeroSesionHeader) {
                const codigoCorto = obtenerCodigoCorto(sessionNumber);
                numeroSesionHeader.textContent = codigoCorto;
            }
            
            // Actualizar nombre de usuario (usando SessionCache)
            const userName = SessionCache.getUserName();
            if (userName) {
                const userNameHeader = document.getElementById('user-name-header');
                const nombreUsuarioHeader = document.getElementById('nombre-usuario-header');
                if (userNameHeader && nombreUsuarioHeader) {
                    nombreUsuarioHeader.textContent = userName;
                    userNameHeader.style.display = 'block';
                }
            }
            
            // Cargar categor√≠as
            cargarCategorias();
            
            // Mostrar lista de categor√≠as
            mostrarSelectorCategorias();
        }
        
        // Variables para el timer de mantener presionado
        let pressTimer = null;
        let isPressing = false;

        // Mostrar selector de categor√≠as
        function mostrarSelectorCategorias() {
            if (!categoriasData) {
                if (typeof NotificationUtils !== 'undefined') {
                    NotificationUtils.error('Error: No se pudieron cargar las categor√≠as');
                } else {
                    alert('Error: No se pudieron cargar las categor√≠as');
                }
                return;
            }
            
            // Obtener lista de categor√≠as
            const listaCategorias = document.getElementById('lista-categorias');
            if (!listaCategorias) return;
            
            // Limpiar lista de forma segura (optimizaci√≥n: usar removeChild en lugar de innerHTML)
            while (listaCategorias.firstChild) {
                listaCategorias.removeChild(listaCategorias.firstChild);
            }
            
            // Cachear modal de carga para evitar m√∫ltiples queries (optimizaci√≥n)
            const modalCargando = document.getElementById('modal-cargando');
            
            // Usar DocumentFragment para mejor performance (optimizaci√≥n)
            const fragment = document.createDocumentFragment();
            
            Object.keys(categoriasData).forEach(categoria => {
                const botonCategoria = document.createElement('button');
                botonCategoria.className = 'btn-categoria';
                const cantidadElementos = categoriasData[categoria]?.length || 0;
                botonCategoria.textContent = `${categoria} (${cantidadElementos})`;
                
                // Event listener para click normal
                botonCategoria.addEventListener('click', function(e) {
                    // Solo ejecutar si no se estaba manteniendo presionado
                    if (!isPressing && !pressTimer) {
                        // Agregar clase selected para mantener el color naranja
                        botonCategoria.classList.add('selected');
                        
                        // Mostrar popup de carga inmediatamente
                        if (modalCargando) {
                            modalCargando.style.display = 'flex';
                        }
                        
                        iniciarJuegoConCategoria(categoria);
                    }
                });
                
                // Event listeners para mantener presionado (mouse)
                botonCategoria.addEventListener('mousedown', function() {
                    iniciarTimerPresionado(categoria);
                });
                
                botonCategoria.addEventListener('mouseup', function() {
                    cancelarTimerPresionado();
                });
                
                botonCategoria.addEventListener('mouseleave', function() {
                    cancelarTimerPresionado();
                });
                
                // Event listeners para mantener presionado (touch)
                botonCategoria.addEventListener('touchstart', function(e) {
                    iniciarTimerPresionado(categoria);
                }, { passive: true });
                
                botonCategoria.addEventListener('touchend', function(e) {
                    cancelarTimerPresionado();
                }, { passive: true });
                
                botonCategoria.addEventListener('touchcancel', function(e) {
                    cancelarTimerPresionado();
                }, { passive: true });
                
                // Agregar al fragment en lugar de directamente al DOM (optimizaci√≥n)
                fragment.appendChild(botonCategoria);
            });
            
            // Agregar todos los botones de una vez (m√°s eficiente)
            listaCategorias.appendChild(fragment);
        }
        
        // Iniciar timer cuando se presiona el bot√≥n
        function iniciarTimerPresionado(categoria) {
            isPressing = true;
            pressTimer = setTimeout(function() {
                mostrarElementosCategoria(categoria);
                isPressing = false;
            }, CONFIG.TIEMPO_MOSTRAR_CONTENIDO); // Usar constante de CONFIG
        }
        
        // Cancelar timer cuando se suelta el bot√≥n
        function cancelarTimerPresionado() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            // Resetear isPressing inmediatamente
            isPressing = false;
        }
        
        // Mostrar elementos de la categor√≠a en el popup
        function mostrarElementosCategoria(categoria) {
            const elementos = categoriasData[categoria];
            if (!elementos || elementos.length === 0) {
                return;
            }
            
            // Obtener elementos del modal
            const modal = document.getElementById('modal-elementos-categoria');
            const titulo = document.getElementById('titulo-categoria-modal');
            const lista = document.getElementById('lista-elementos-categoria');
            
            if (!modal || !titulo || !lista) return;
            
            titulo.textContent = categoria;
            
            // Usar DocumentFragment para mejor performance (optimizaci√≥n)
            const fragment = document.createDocumentFragment();
            
            elementos.forEach((elemento, index) => {
                const item = document.createElement('div');
                item.className = 'elemento-item';
                item.textContent = `${index + 1}. ${elemento}`;
                fragment.appendChild(item);
            });
            
            // Limpiar lista de forma segura (optimizaci√≥n: usar removeChild en lugar de innerHTML)
            while (lista.firstChild) {
                lista.removeChild(lista.firstChild);
            }
            lista.appendChild(fragment);
            
            modal.style.display = 'flex';
        }
        
        // Cerrar modal de elementos (funci√≥n global)
        window.cerrarModalElementos = function() {
            // Obtener modal
            const modal = document.getElementById('modal-elementos-categoria');
            if (modal) {
                modal.style.display = 'none';
            }
            // Resetear el estado de presionado
            isPressing = false;
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
        };
        
        // Iniciar juego con una categor√≠a seleccionada
        async function iniciarJuegoConCategoria(categoria) {
            // Usar SessionCache para mejor performance (optimizaci√≥n)
            const sessionNumber = SessionCache.getSessionNumber();
            const userName = SessionCache.getUserName();
            
            if (!sessionNumber || !userName) {
                if (typeof NotificationUtils !== 'undefined') {
                    NotificationUtils.error('Error: No se encontr√≥ informaci√≥n de sesi√≥n o usuario');
                } else {
                    alert('Error: No se encontr√≥ informaci√≥n de sesi√≥n o usuario');
                }
                return;
            }
            
            // Obtener lista de usuarios de la sesi√≥n
            const usuarios = await obtenerUsuariosSesion(sessionNumber);
            
            // Filtrar usuarios v√°lidos
            const usuariosValidos = filtrarUsuariosValidos(usuarios);
            
            if (usuariosValidos.length < 3) {
                if (typeof NotificationUtils !== 'undefined') {
                    NotificationUtils.warning('Se necesitan al menos 3 usuarios para jugar');
                } else {
                    alert('Se necesitan al menos 3 usuarios para jugar');
                }
                return;
            }
            
            // Elegir elemento aleatorio de la categor√≠a
            const elementos = categoriasData[categoria];
            const elementoElegido = elementos[Math.floor(Math.random() * elementos.length)];
            
            // Elegir impostor aleatorio
            const impostorIndex = Math.floor(Math.random() * usuariosValidos.length);
            const impostor = usuariosValidos[impostorIndex];
            
            // Crear estado del juego
            const estadoJuego = {
                categoria: categoria,
                elemento: elementoElegido,
                impostor: impostor.usuario,
                activo: true,
                iniciadoPor: userName,
                iniciadoEn: new Date().toISOString()
            };
            
            // Guardar estado del juego en Supabase
            debugLog('üíæ Guardando juego en Supabase...');
            debugLog('üìã Estado del juego a guardar:', estadoJuego);
            
            await guardarEstadoJuego(sessionNumber, estadoJuego);
            
            debugLog('‚úÖ Juego guardado, esperando confirmaci√≥n...');
            
            // Esperar un momento para asegurar que Supabase procese el cambio (usar CONFIG)
            await new Promise(resolve => setTimeout(resolve, CONFIG.DELAY_REINTENTO_JUEGO));
            
            // Redirigir de vuelta a la sesi√≥n
            window.location.href = 'sesion.html';
        }
        
        // Configurar bot√≥n cerrar modal de elementos
        function configurarModalElementos() {
            const btnCerrar = document.getElementById('btn-cerrar-elementos');
            const modal = document.getElementById('modal-elementos-categoria');
            
            if (btnCerrar) {
                btnCerrar.addEventListener('click', window.cerrarModalElementos);
            }
            
            // Cerrar modal al hacer click fuera
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        window.cerrarModalElementos();
                    }
                });
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initSeleccionarCategoria();
                configurarModalElementos();
            });
        } else {
            initSeleccionarCategoria();
            configurarModalElementos();
        }
    </script>
    
    <footer>
        <p id="footer-version">Impostor v<span id="version-number">1.2</span> desarrollado por Astutosoft ¬© 2025</p>
    </footer>
</body>
</html>

